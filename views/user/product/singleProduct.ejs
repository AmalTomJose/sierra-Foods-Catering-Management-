
<style>
  .product-description {
  background-color: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  line-height: 1.6;
  font-size: 16px;
  color: #333;
}

  .zoom-container {
    overflow: hidden;
    position: relative;
    background: #f9f9f9;
  }

  .main-carousel-img {
    transition: transform 0.4s ease;
    max-height: 450px;
    object-fit: contain;
    cursor: zoom-in;
  }

  .zoom-container:hover .main-carousel-img {
    transform: scale(1.5);
    z-index: 10;
  }

  .carousel-thumb {
    border: 2px solid transparent;
    transition: border 0.3s ease;
  }

  .carousel-thumb:hover, .active-thumb {
    border-color: #088178;
  }
</style>


<!-- Product Detail Start -->
<div class="container-xxl py-5">
  <div class="container" style="padding-top: 60px;">
    <div class="row g-5">

      <!-- Image Gallery -->
      <div class="col-lg-6 mt-5">
        <% if (product.item_image && product.item_image.length > 0) { %>
          <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
            <!-- Main Zoomable Image -->
            <div class="carousel-inner mb-3">
              <% product.item_image.forEach((img, index) => { %>
                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                  <div class="zoom-container">
                    <img src="/admin-assets/imgs/productIMG/<%= img %>" class="d-block w-100 rounded main-carousel-img" alt="Product Image <%= index + 1 %>">
                  </div>
                </div>
              <% }) %>
            </div>
      
            <!-- Carousel Controls -->
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
      
            <!-- Thumbnail Indicators -->
            <div class="d-flex justify-content-center gap-2 mt-3">
              <% product.item_image.forEach((img, index) => { %>
                <img 
                  src="/admin-assets/imgs/productIMG/<%= img %>" 
                  data-bs-target="#productCarousel" 
                  data-bs-slide-to="<%= index %>" 
                  class="img-thumbnail carousel-thumb <%= index === 0 ? 'active-thumb' : '' %>" 
                  alt="Thumb <%= index + 1 %>" 
                  style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;">
              <% }) %>
            </div>
          </div>
        <% } else { %>
          <img src="/images/default-image.jpg" class="img-fluid rounded" alt="No Image Available">
        <% } %>
      </div>
      
      <!-- Product Info -->
      <div class="col-lg-6">
        <h2><%= product.item_name %></h2>

        <p class="text-muted">
          Category: <strong><%= product.category?.cat_name || 'Uncategorized' %></strong>
        </p>

        <p class="text-muted">
          SubCategory: <strong><%= product.subcategory?.subcat_name || 'Uncategorized' %></strong>
        </p>

        <% if (product.appliedOffer) { %>
          <div class="p-3 mb-3 bg-light border rounded">
            <h5 class="text-success mb-1">Special Offer</h5>
            <p class="mb-1">
              <% if (product.appliedOffer.discountType === 'percentage') { %>
                <strong><%= product.appliedOffer.discountValue %>%</strong> off this product!
              <% } else { %>
                Save â‚¹<%= product.appliedOffer.discountValue %> on this product!
              <% } %>
            </p>
            <p class="text-muted small mb-0">
              Valid until <%= new Date(product.appliedOffer.endDate).toLocaleDateString() %>
            </p>
                      </div>
          <h4 class="mb-3 text-primary">
            â‚¹<%= product.offerPrice %> <del class="text-muted small">â‚¹<%= product.item_price %></del>
          </h4>
          
        <% } else { %>
          <h4 class="text-primary mb-3">â‚¹<%= product.item_price %></h4>
        <% } %>
        

        <div class="product-description">
          <p><%= product.item_description %></p>
        </div>
        
        <div class="bt-1 border-color-1 mt-30 mb-30"></div>
<!-- Add to Cart Form -->
<form id="addToCartForm">
  <input type="hidden" name="productData_id" id="productData_id" value="<%= product._id %>">

  <% if (error) { %>
    <div class="alert alert-warning mt-3"><%= error %></div>
    <a href="/eventDetails" class="btn btn-primary mt-2">Book an Event</a>
  <% } else { %>
    <div class="row g-2 align-items-center">
      <!-- Quantity Input -->
      <div class="col-auto">
        <input
          type="number"
          name="qty"
          id="qty"
          class="form-control"
          style="width: 120px;"
          value="<%= guestCount %>"
          min="<%= minOrderQty %>"
          max="<%=guestCount%>"
          required
        >
      </div>

      <!-- Add to Cart Button -->
      <div class="col-auto">
        <button type="submit" id="addToCartBtn" class="btn btn-success px-4">
          <span>Add To Cart</span>
        </button>
      </div>
    </div>

    <small class="text-muted d-block mt-2">
      Minimum order for <strong><%= guestCount %></strong> guests is <strong><%= minOrderQty %></strong> items.
    </small>
  <% } %>
</form>

        
        <!-- Add to Wishlist Button -->
        <div class="detail-extralink">
          <div class="product-extra-link2 w-50 my-1">
            <button type="button" aria-label="Add To Wishlist" class="wishlist-button"
              onclick="addToWishlist('<%= product._id %>')">
              <i class="fi-rs-heart"></i> Add to Wishlist
            </button>
          </div>
        </div>
        <% if (typeof error !== 'undefined' && error) { %>
          <div class="alert alert-danger text-center">
            <%= error %>
          </div>
        <% } %>


    

        

      </div>
    </div>
  </div>
</div>
    <!-- Similar Products Section -->
    <div class="container mt-5">
      <h3 class="mb-4">Similar Products</h3>
      <div class="row g-4">
        <% if (similarProducts && similarProducts.length > 0) { %>
          <% similarProducts.forEach(similar => { %>
            <div class="col-md-4 col-lg-3">
              <div class="card h-100 shadow-sm">
                <img src="/admin-assets/imgs/productIMG/<%= similar.item_image[0] %>" 
                     class="card-img-top" 
                     alt="<%= similar.item_name %>" 
                     style="height: 200px; object-fit: cover;">
                <div class="card-body">
                  <h6 class="card-title"><%= similar.item_name %></h6>
                  <p class="text-primary fw-bold">â‚¹<%= similar.item_price %></p>
                  <a href="/product/<%= similar._id %>" class="btn btn-sm btn-outline-success">
                    View Details
                  </a>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-muted">No similar products found.</p>
        <% } %>
      </div>
    </div>
<!-- Product Detail End -->

<!-- Styles -->
<style>
  .zoomable-img {
    transition: transform 0.3s ease;
    cursor: zoom-in;
  }

  .carousel-item {
    overflow: hidden;
    position: relative;
  }

  .zoomable-img:hover {
    transform: scale(1.5);
    z-index: 1000;
  }

  .wishlist-button {
    font-size: 15px;
    font-weight: 500;
    padding: 12px 40px;
    color: #ffffff;
    background-color: #088178;
    border: 1px solid #046963;
    border-radius: 5px;
    border: none;
  }

  .wishlist-button:hover {
    background-color: #046963;
  }
</style>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ðŸ’– Wishlist AJAX
  function addToWishlist(productId) {
    fetch('/addToWishlist', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },  
      body: JSON.stringify({ productId })
    })
    .then(res => res.json())
    .then(data => {
      Swal.fire({
        title: data.success ? "Success!" : "Error!",
        text: data.success ? data.message : data.error || "Failed to add to wishlist.",
        icon: data.success ? "success" : "error"
      });
    })
    .catch(() => Swal.fire("Error!", "Something went wrong.", "error"));
  }

  // ðŸ›’ Add to Cart AJAX + Validation
  const minQty = <%= minOrderQty %>;
  const guestCount = <%= guestCount %>;

  document.getElementById('addToCartForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();

    const qty = parseInt(document.getElementById('qty').value);
    const productId = document.getElementById('productData_id').value;

    // ðŸ§  Validation: Minimum Quantity Check
    if (qty < minQty) {
      Swal.fire({
        icon: 'warning',
        title: 'Quantity Too Low',
        text: `For ${guestCount} guests, minimum order is ${minQty} items.`,
      });
      return;
    }

    try {
      const res = await fetch('/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, qty })
      });

      const data = await res.json();

      Swal.fire({
        title: data.success ? "Added to Cart!" : "Error!",
        text: data.success ? data.message : data.error || "Failed to add to cart.",
        icon: data.success ? "success" : "error"
      });

    } catch (err) {
      console.error('Cart Error:', err);
      Swal.fire("Error!", "Something went wrong while adding to cart.", "error");
    }
  });
</script>
