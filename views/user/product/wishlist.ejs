<section class="mt-50" style="margin-bottom: 200px; padding-top: 100px;">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <% if (Wishlist.items && Wishlist.items.length > 0) { %>
          <% if (typeof error !== 'undefined' && error.length > 0) { %>
            <div class="alert alert-danger text-center">
              <%= error %>
            </div>
          <% } %>
          <table class="table shopping-summery">
            <thead class="thead-dark">
              <tr class="main-heading">
                <th scope="col">Image</th>
                <th scope="col">Product Name</th>
                <th scope="col">Action</th>
                <th scope="col">Remove</th>
              </tr>
            </thead>
            <tbody>
              <% for(let i = 0; i < Wishlist.items.length; i++) { %>
                <tr>
                  <!-- Product Image -->
                  <td class="image product-thumbnail">
                    <% const img = Wishlist.items[i].product.item_image[0]; %>
                    <% if (img) { %>
                      <img alt="<%= Wishlist.items[i].product.item_name %>" 
                           src="/admin-assets/imgs/productIMG/<%= img %>" 
                           class="img-fluid rounded" 
                           style="max-width: 120px; height: 120px;">
                    <% } else { %>
                      <span>No image</span>
                    <% } %>
                  </td>

                  <!-- Product Name -->
                  <td class="product-des product-name">
                    <h5 class="product-name">
                      <a href="/product/<%= Wishlist.items[i].product._id %>" class="text-dark">
                        <%= Wishlist.items[i].product.item_name %>
                      </a>
                    </h5>
                  </td>

                  <!-- Add to Cart -->
                  <td class="text-right" data-title="Cart">
                    <form class="addToCartForm text-right">
                      <input type="hidden" name="productId" class="productData_id" value="<%= Wishlist.items[i].product._id %>">
                      <input type="hidden" name="qty" class="qty" value="<%= qty %>">

                      <div class="row">
                        <div class="col-auto text-right">
                          <% if (qty && qty > 1) { %>
                            <button type="submit" class="btn btn-success px-4">
                              <span>Add To Cart</span>
                            </button>
                          <% } else { %>
                            <a href="/eventDetails" class="btn btn-danger px-4">Book an Event</a>
                          <% } %>
                        </div>
                      </div>
                    </form>
                  </td>

                  <!-- Remove -->
                  <td>
                    <button type="button" 
                            onclick="confirmRemoveWishlistItem('<%= Wishlist.items[i].product._id %>');" 
                            class="btn btn-sm btn-danger">
                      <i class="fi-rs-trash me-2"></i>Remove
                    </button>
                  </td>
                </tr>
              <% } %> <!-- âœ… correct EJS closing -->
            </tbody>
          </table>
        <% } else { %>
          <div class="text-center mt-4">
            <h3 class="text-warning">Your Wishlist is Empty</h3>
            <a href="/shop" class="btn btn-lg btn-outline-primary mt-3">
              <i class="fa-solid fa-cart-shopping"></i> Continue Shopping
            </a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</section>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function confirmRemoveWishlistItem(productId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You want to delete the item",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, remove it!",
    }).then((result) => {
      if (result.isConfirmed) {
        removeWishlistItem(productId);
      }
    });
  }

  function removeWishlistItem(productId) {
    fetch(`/removeWishlist?productId=${productId}`, {
      method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        console.error('Failed to remove wishlist item:', data.error);
      }
    })
    .catch(error => {
      console.error('Error removing wishlist item:', error);
    });
  }

  // Add to Cart AJAX (for all forms)
  document.querySelectorAll('.addToCartForm').forEach(form => {
    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const productId = this.querySelector('.productData_id').value;
      const qty = this.querySelector('.qty').value;

      fetch('/cart', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ productId, qty })
})
.then(res => res.json())
.then(data => {
  Swal.fire({
    title: data.success ? "Success!" : "Error!",
    text: data.success ? data.message : data.error || "Failed to add to cart.",
    icon: data.success ? "success" : "error"
  }).then(() => {
    if (data.success) {
      window.location.reload(); // reload only if success
    }
  });
})
.catch(err => {
  console.error('Cart Error:', err);
  alert('Something went wrong while adding to cart.');
});

    });
  });
</script>

<style>
  table {
    border-collapse: collapse;
    width: 100%;
  }
  table th, table td {
    padding: 15px;
    vertical-align: middle;
    text-align: center;
  }
  table th {
    background-color: #f8f9fa;
    color: #495057;
  }
  table td {
    background-color: #ffffff;
    border-bottom: 1px solid #e9ecef;
  }
  table td img {
    border-radius: 8px;
  }
  .table th, .table td {
    border: none;
  }
  .table thead {
    border-bottom: 2px solid #dee2e6;
  }
</style>
