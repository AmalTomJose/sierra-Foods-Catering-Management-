<!-- ==================== Product Page ==================== -->
<div class="container-xxl py-5">
  <div class="container">
    <div class="row g-0 gx-5 align-items-end">
      <div class="col-lg-6">
        <div class="section-header text-start mb-5 wow fadeInUp" data-wow-delay="0.1s" style="max-width: 500px;">
          <h1 class="display-5 mb-3">Our Products</h1>
        </div>
      </div>
    </div>

    <!-- ==================== Search + Sort + Category ==================== -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
      
      <!-- Search + Sort Form -->
      <form id="filterForm" class="d-flex flex-wrap align-items-center gap-2 w-100 w-lg-auto">
        <div class="flex-grow-1 flex-md-grow-0" style="min-width: 200px;">
          <input 
            type="search" 
            class="form-control" 
            name="search" 
            id="search" 
            placeholder="Search products..." 
            value="<%= query.search || '' %>"
          />
        </div>

        <div class="flex-grow-0">
          <select 
            name="sort" 
            class="form-select"
            style="min-width: 180px;"
          >
            <option value="asc" <%= sort === 'asc' ? 'selected' : '' %>>Price: Low to High</option>
            <option value="desc" <%= sort === 'desc' ? 'selected' : '' %>>Price: High to Low</option>
          </select>
        </div>

        <div class="flex-grow-0">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
      </form>

      <!-- Category Pills -->
      <ul class="nav nav-pills flex-wrap justify-content-center justify-content-lg-end" id="category-pills">
        <% categories.forEach(cat => { %>
          <li class="nav-item me-2 mb-2">
            <button 
              type="button"
              class="btn btn-outline-primary border-2 category-pill <%= cat._id == query.category ? 'active' : '' %>" 
              data-id="<%= cat._id %>"
            >
              <%= cat.cat_name %>
            </button>
          </li>
        <% }); %>
      </ul>
    </div>
    <!-- ==================== End Search + Sort + Category ==================== -->

    <!-- Product Listing -->
    <div id="product-listing">
      <%- include("../../partials/user/shopCategory", { products, totalPages, currentPage }) %>
    </div>
  </div>
</div>
<!-- ==================== End Product Page ==================== -->


<!-- ✅ SweetAlert for messages -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const pills = document.querySelectorAll('.category-pill');
    const searchInput = document.querySelector('input[name="search"]');
    const sortSelect = document.querySelector('select[name="sort"]');
    const searchForm = document.getElementById('filterForm');
    let currentPage = 1;
    let selectedCategory = "<%= query.category || '' %>";

    // ✅ Fetch products with AJAX
    function fetchFilteredProducts() {
      const search = searchInput.value;
      const sort = sortSelect.value;
      const container = document.getElementById('product-listing');
      container.innerHTML = '<div class="text-center w-100 py-5"><div class="spinner-border text-primary" role="status"></div></div>';

      fetch(`/shop/ajax?category=${selectedCategory}&search=${encodeURIComponent(search)}&sort=${sort}&page=${currentPage}`)
        .then(res => res.text())
        .then(html => {
          container.innerHTML = html || '<div class="text-center text-muted w-100 py-5">No products found.</div>';
          attachPaginationEvents();
        })
        .catch(err => {
          console.error('Error loading products:', err);
          container.innerHTML = '<div class="text-danger w-100 text-center py-5">Failed to load products.</div>';
        });
    }

    // ✅ Pagination handler
    function attachPaginationEvents() {
      document.querySelectorAll('.pagination-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = parseInt(link.getAttribute('data-page'));
          fetchFilteredProducts();
        });
      });
    }

    // ✅ Category selection
    pills.forEach(pill => {
      pill.addEventListener('click', () => {
        selectedCategory = pill.getAttribute('data-id');
        pills.forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        currentPage = 1;
        fetchFilteredProducts();
      });
    });

    // ✅ Search form submit
    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      currentPage = 1;
      fetchFilteredProducts();
    });

    // ✅ Sort change
    sortSelect.addEventListener('change', () => {
      currentPage = 1;
      fetchFilteredProducts();
    });

    attachPaginationEvents();
  });
</script>

<!-- ✅ Success Alert -->
<% if (success && success.length > 0) { %>
  <script>
    Swal.fire({
      icon: 'success',
      text: '<%= success[0] %>',
    });
  </script>
<% } %>

<!-- ✅ Responsive Styling -->
<style>
  /* Main filter section */
  #filterForm {
    gap: 10px;
  }

  @media (max-width: 767px) {
    #filterForm {
      flex-direction: column;
      align-items: stretch;
    }

    #filterForm input,
    #filterForm select,
    #filterForm button {
      width: 100% !important;
    }

    #filterForm button {
      margin-top: 5px;
    }

    #category-pills {
      justify-content: flex-start;
    }
  }

  @media (min-width: 768px) and (max-width: 991px) {
    #filterForm {
      justify-content: space-between;
    }

    #filterForm input {
      width: 60%;
    }

    #filterForm select {
      width: 30%;
    }

    #filterForm button {
      width: auto;
    }
  }

  /* Category pills responsive */
  #category-pills .btn {
    white-space: nowrap;
  }
</style>
