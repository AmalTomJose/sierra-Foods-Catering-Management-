<main class="main" style="margin-bottom: 200px; padding-top: 100px;">
  <section class="mt-50 mb-50">
    <div class="container">
      <div class="row">
        <div class="col-12">

          <% if (error && error.length > 0) { %>
            <div class="alert alert-danger text-center fw-semibold mx-auto"
              style="max-width: 500px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <i class="bi bi-exclamation-circle-fill me-2"></i><%= error %>
            </div>
          <% } %>

          <div class="table-responsive">

            <% if (cart.length > 0) { %>
              <table class="table shopping-summery text-center clean">
                <thead class="thead-dark">
                  <tr class="main-heading">
                    <th>Image</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody>
                  <% cart.forEach((cartData, index) => { %>
                    <tr>
                      <td class="image product-thumbnail" data-label="Image">
                        <img src="/admin-assets/imgs/productIMG/<%= cartData.product.item_image[0] %>"
                          alt="#" class="img-fluid rounded" style="max-width: 120px; height: 120px;">
                      </td>

                      <td class="product-des product-name" data-label="Name">
                        <%= cartData.product.item_name %><br />
                        <% if (cartData.offerApplied && cartData.offerApplied > 0) { %>
                          <span class="badge bg-success">Offer Applied</span>
                        <% } %>
                      </td>

                      <td data-label="Price">
                        <% if (cartData.offerApplied && cartData.offerApplied > 0) { %>
                          <span class="text-muted text-decoration-line-through">₹<%= cartData.product.item_price %></span><br>
                          <strong>₹<%= cartData.discountedPrice %></strong><br>
                          <small class="text-success">You save ₹<%= cartData.offerApplied %></small>
                        <% } else { %>
                          ₹<%= cartData.product.item_price %>
                        <% } %>
                      </td>

                      <td data-label="Quantity">
                        <form
                          onsubmit="event.preventDefault(); updateCart('<%= cartData.product._id %>', this.elements['quantity'].value)">
                          <div class="input-group quantity-group mx-auto" style="max-width: 130px;">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                              onclick="changeQuantity(this, -1)">−</button>
                            <input type="number" name="quantity" min="<%= minQty %>" max="<%= maxQty %>"
                              value="<%= cartData.quantity %>" class="form-control text-center form-control-sm">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                              onclick="changeQuantity(this, 1)">+</button>
                          </div>
                        </form>
                      </td>

                      <td data-label="Subtotal">₹<%= productTotal[index] %></td>

                      <td data-label="Remove">
                        <button type="button" class="btn btn-sm btn-danger"
                          onclick="confirmRemoveCartItem('<%= cartData.product._id %>')">
                          <i class="fi-rs-trash me-2"></i>Remove
                        </button>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            <% } else { %>
              <div class="text-center mt-4">
                <h3 class="text-warning">Your Cart is Empty</h3>
                <a href="/shop" class="btn btn-lg btn-outline-primary mt-3">
                  <i class="fa-solid fa-cart-shopping"></i> Continue Shopping
                </a>
              </div>
            <% } %>
          </div>

          <% if (cart.length > 0) { %>
            <div class="cart-action text-end mt-4">
              <a class="btn btn-success fw-semibold shadow-sm px-4 py-2" href="/shop"
                style="background-color:#16a34a; border:none; border-radius:8px; color:white; font-size:16px; transition:0.3s;">
                <i class="fi-rs-shopping-bag me-2"></i> Continue Shopping
              </a>
            </div>

            <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>

            <div class="row mb-50">
              <div class="col-lg-6 col-md-12"></div>
              <div class="col-lg-6 col-md-12">
                <div class="border p-md-4 p-30 border-radius cart-totals">
                  <div class="heading_s1 mb-3">
                    <h4>Cart Totals</h4>
                  </div>
                  <table class="table">
                    <tr>
                      <td>Subtotal</td>
                      <td>₹<%= subtotalWithShipping + offerDiscount %></td>
                    </tr>
                    <tr>
                      <td>Offer Discount</td>
                      <td class="text-success">- ₹<%= offerDiscount %></td>
                    </tr>
                    <tr>
                      <td>Delivery</td>
                      <td>Free Delivery</td>
                    </tr>
                    <tr>
                      <td><strong>Total</strong></td>
                      <td><strong>₹<%= subtotalWithShipping %></strong></td>
                    </tr>
                  </table>
                  <a href="/checkout"
                    class="btn btn-success mt-3 fw-semibold shadow-sm px-4 py-2 w-100"
                    style="background-color:#16a34a; border:none; border-radius:8px; color:white; font-size:16px; transition:0.3s;">
                    <i class="fi-rs-box-alt me-2"></i> Proceed to Checkout
                  </a>
                </div>
              </div>
            </div>
          <% } %>

        </div>
      </div>
    </div>
  </section>
</main>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function confirmRemoveCartItem(productId) {
    Swal.fire({
      title: "Are you sure?",
      text: "This item will be removed from your cart.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, remove it!",
      cancelButtonText: "Cancel"
    }).then((result) => {
      if (result.isConfirmed) removeCartItem(productId);
    });
  }
  
  function removeCartItem(productId) {
    fetch(`/remove-cart-item?productId=${productId}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        if (data.success) location.reload();
        else console.error(data.error);
      });
  }
  async function updateCart(productId, newQuantity, row) {
  try {
    const res = await fetch(`/updateCart?productId=${productId}&quantity=${newQuantity}`, { method: 'PUT' });
    const data = await res.json();

    if (!data.success) {
      Swal.fire({ icon: 'error', title: 'Update Failed', text: data.error || 'Failed to update cart.' });
      return;
    }

    // ✅ Find the current product's updated total
    const updatedItem = data.updatedItems.find(i => i.productId === productId);
    if (updatedItem) {
      const subtotalCell = row.querySelector('[data-label="Subtotal"]');
      subtotalCell.textContent = `₹${updatedItem.total.toFixed(2)}`;
    }

    // ✅ Update totals dynamically
    const subtotalElement = document.querySelector('.cart-totals table tr:first-child td');
    const discountElement = document.querySelector('.cart-totals table tr:nth-child(2) td');
    const totalElement = document.querySelector('.cart-totals table tr:last-child td strong');

    if (subtotalElement) subtotalElement.textContent = `₹${(data.subtotal + data.offerDiscount).toFixed(2)}`;
    if (discountElement) discountElement.textContent = `- ₹${data.offerDiscount.toFixed(2)}`;
    if (totalElement) totalElement.textContent = `₹${data.subtotal.toFixed(2)}`;

  } catch (error) {
    console.error(error);
    Swal.fire({ icon: 'error', title: 'Error', text: 'Something went wrong. Please try again.' });
  }
}

  
  function changeQuantity(button, change) {
    const input = button.parentElement.querySelector('input[name="quantity"]');
    let value = parseInt(input.value);
    const min = parseInt(input.min);
    const max = parseInt(input.max);
    const newVal = Math.min(max, Math.max(min, value + change));
    input.value = newVal;
  
    // Find the table row of this item
    const row = button.closest('tr');
    const productId = row.querySelector('form').getAttribute('onsubmit').match(/'([^']+)'/)[1];
  
    // ✅ Immediately update backend and subtotal dynamically
    updateCart(productId, newVal, row);
  }
  
  // ✅ Function to recalculate total
  function updateCartTotal() {
    let total = 0;
    document.querySelectorAll('td[data-label="Subtotal"]').forEach(cell => {
      total += parseFloat(cell.textContent.replace('₹', '')) || 0;
    });
  
    const offerDiscount = parseFloat('<%= offerDiscount %>') || 0;
    const totalCell = document.querySelector('td strong');
    const totalElement = document.querySelector('.cart-totals table tr:last-child td strong');
    const subtotalElement = document.querySelector('.cart-totals table tr:first-child td');
  
    if (subtotalElement) subtotalElement.textContent = `₹${(total + offerDiscount).toFixed(2)}`;
    if (totalElement) totalElement.textContent = `₹${total.toFixed(2)}`;
  }
  </script>
  
<style>
/* Quantity Buttons */
.quantity-group input {
  width: 50px;
}
.quantity-group .btn-sm {
  padding: 2px 8px;
  font-size: 14px;
}

/* Table Styling */
.table th, .table td {
  padding: 15px;
  vertical-align: middle;
  text-align: center;
}
.table th {
  background-color: #f8f9fa;
  color: #495057;
}
.table td {
  background-color: #ffffff;
  border-bottom: 1px solid #e9ecef;
}
.cart-totals {
  background-color: #f8f9fa;
}

/* ===================== CART RESPONSIVE STYLES ===================== */
@media (max-width: 768px) {
  .table thead {
    display: none;
  }
  .table tbody tr {
    display: block;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    padding: 15px;
  }
  .table tbody td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: none !important;
    padding: 8px 0;
    text-align: left;
  }
  .table tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    color: #555;
    flex-basis: 40%;
  }
  .table tbody td.image img {
    max-width: 80px;
    height: 80px;
    border-radius: 8px;
  }
  .quantity-group {
    max-width: 100px;
  }
  .cart-totals {
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .cart-totals .btn {
    width: 100%;
    font-size: 16px;
  }
}
</style>

<% if (success && success.length > 0) { %>
<script>
Swal.fire({
  icon: 'success',
  title: 'Success!',
  text: '<%= success[0] %>',
  confirmButtonColor: '#3085d6'
});
</script>
<% } %>
