<main class="main" style="margin-bottom: 200px; padding-top: 100px;">
  <section class="mt-50 mb-50">
    <div class="container">
      <div class="row"><div class="col-12"><div class="divider mt-50 mb-50"></div></div></div>
      <div class="row">
        <!-- Left Side: Address -->
        <div class="col-md-6">
          <div class="row">
            <% if (addressData) { %>
              <div class="col-12">
                <div class="card mb-3 mb-lg-0">
                  <div class="card-header">
                    <h5 class="mb-0 d-flex justify-content-between">
                      <span><%= userData.firstname %></span>
                      <span><%= userData.phoneno %></span>
                    </h5>
                  </div>
                  <div class="card-body d-flex justify-content-between">
                    <address>
                      <strong>Event Date:</strong> 
                      <%= new Date(addressData.eventDate).toLocaleDateString('en-IN', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                      }) %><br>
                                            <strong>Event Type:</strong> <%= addressData.eventType %><br>
                      <strong>Guests:</strong> <%= addressData.guestCount %><br>
                      <strong>Place:</strong> <%= addressData.eventPlace %><br>
                      <strong>Time:</strong> <%= addressData.eventTime %><br>
                      <strong>District:</strong> <%= addressData.eventDistrict %><br>
                      <strong>Pincode:</strong> <%= addressData.eventPincode %>
                    </address>
                    <div class="d-flex align-items-center">
                      <input type="radio" name="checkAddress" value="<%= addressData._id %>" id="addressradio" class="me-3">
                      <a href="/updateBooking?id=<%= addressData._id %>" class="btn-small">Edit</a>
                    </div>
                  </div>
                </div>
              </div>
            <% } else { %>
              <div class="col-12">
                <div class="alert alert-info">No address found. Please add one.</div>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Right Side: Order Summary -->
        <div class="col-md-6">
          <div class="order_review">
            <h4 class="mb-20">Your Orders</h4>

            <div class="table-responsive order_table text-center">
              <table class="table">
                <thead><tr><th colspan="2">Product</th><th>Total</th></tr></thead>
                <tbody>
                  <% if (cart && cart.length > 0) { %>
                    <% cart.forEach((cartData, index) => { 
                      const originalPrice = cartData.product.item_price * cartData.quantity;
                      const finalPrice = productTotal[index];
                      const discount = originalPrice - finalPrice;
                    %>
                      <tr>
                        <td class="image product-thumbnail">
                          <img src="/admin-assets/imgs/productIMG/<%= cartData.product.item_image[0] %>" alt="#">
                        </td>
                        <td>
                          <h5><%= cartData.product.name %></h5>
                          <span class="product-qty">x <%= cartData.quantity %></span><br>
                          <small class="text-muted">Original: â‚¹<%= cartData.product.item_price %></small><br>
                          <% if (discount > 0) { %>
                            <small class="text-success">Offer: -â‚¹<%= discount / cartData.quantity %></small><br>
                            <strong class="text-danger">Now: â‚¹<%= finalPrice / cartData.quantity %></strong>
                          <% } else { %>
                            <strong>Price: â‚¹<%= cartData.product.item_price %></strong>
                          <% } %>
                        </td>
                        <td>â‚¹<%= finalPrice %></td>
                      </tr>
                    <% }) %>
                
                    <tr>
                      <th>Product Total</th>
                      <td colspan="2">â‚¹<%= subtotalWithShipping + offerDiscount %></td>
                    </tr>
                    <tr>
                      <th>Offer Discount</th>
                      <td colspan="2" class="text-success">- â‚¹<%= offerDiscount %></td>
                    </tr>
                    <tr><th>SubTotal</th><td colspan="2" id="subtotalAmount">â‚¹<%= subtotalWithShipping %></td></tr>
                    <tr><th>Delivery</th><td colspan="2"><em>Free Delivery</em></td></tr>
                
                    <tr id="discountRow" style="display: none;">
                      <th>Coupon Discount</th>
                      <td colspan="2" id="discountAmount" class="text-danger">- â‚¹0</td>
                    </tr>
                
                    <tr id="advanceRow" style="display: none;">
                      <th>COD Advance (25%)</th>
                      <td colspan="2" id="advanceAmount" class="text-warning">â‚¹0</td>
                    </tr>
                
                    <tr class="summary-total">
                      <td><strong>Final Total</strong></td>
                      <td colspan="2"><strong id="finalAmount">â‚¹<%= subtotalWithShipping %></strong></td>
                    </tr>
                  <% } %>
                </tbody>
                
              </table>
            </div>
            <!-- âœ… Coupon Section -->
<div class="mt-3">
  <label for="couponCode" class="form-label">Apply Coupon</label>
  <div class="input-group">
    <input type="text" id="couponCode" class="form-control" placeholder="Enter coupon code">
    <button id="applyCouponBtn" class="btn btn-outline-primary" type="button">Apply</button>
    <button id="removeCouponBtn" class="btn btn-outline-danger d-none" type="button">Remove</button>
  </div>
  <small id="couponFeedback" class="text-success"></small>
</div>

<div class="mt-3">
  <h6>Available Coupons</h6>
  <div id="availableCoupons" class="border p-3 rounded" style="max-height: 150px; overflow-y: auto;">
    <p class="text-muted">Loading available coupons...</p>
  </div>
</div>



            <!-- Payment Method -->
            <div class="payment_method mt-30">
              <h5>Payment</h5>
              <div class="payment_option">
                <div class="custome-radio">
                  <input class="form-check-input" value="cashondelivery" type="radio" name="payment_option" id="exampleRadios1">
                  <label class="form-check-label" for="exampleRadios1">Cash On Delivery</label>
                </div>
                <div class="custome-radio">
                  <input class="form-check-input" value="online" type="radio" name="payment_option" id="exampleRadios2">
                  <label class="form-check-label" for="exampleRadios2">Online Payment</label>
                </div>
                <div class="custome-radio">
                  <input class="form-check-input" value="wallet" type="radio" name="payment_option" id="exampleRadios3">
                  <label class="form-check-label" for="exampleRadios3">Wallet</label>
                </div>
              </div>
              <div id="codAdvanceNote" class="alert alert-warning mt-3 d-none">
                <strong>Note:</strong> 25% advance payment is required for COD. This amount is <strong>non-refundable</strong>.
              </div>
            </div>

            <!-- Place Order Button -->
            <a href="#" id="btn_checkout" 
   class="btn btn-success btn-block mt-30 fw-semibold shadow-sm px-4 py-2"
   style="background-color:#16a34a; border:none; border-radius:8px; color:white; font-size:16px; transition:0.3s;">
   <i class="fi-rs-box-alt me-2"></i> Place Order
</a>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
<!-- âœ… SweetAlert + Razorpay -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let appliedCoupon = null;
const baseSubtotal = parseFloat("<%= subtotalWithShipping %>"); // original total
let finalAmountValue = baseSubtotal;
let codAdvance = 0;

const applyBtn = document.getElementById('applyCouponBtn');
const removeBtn = document.getElementById('removeCouponBtn');
const codeInput = document.getElementById('couponCode');
const feedback = document.getElementById('couponFeedback');

applyBtn.addEventListener('click', () => {
  const code = codeInput.value.trim();
  if (!code) {
    feedback.textContent = "Please enter or select a coupon.";
    feedback.classList.add('text-danger');
    return;
  }

  // Reset final amount to original baseSubtotal before applying a new coupon
  finalAmountValue = baseSubtotal;

  fetch('/applyCoupon', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code, finalAmountValue: baseSubtotal }) // always send original subtotal
  })
  .then(res => res.json())
  .then(data => {
    const discountRow = document.getElementById('discountRow');
    const discountAmount = document.getElementById('discountAmount');
    const finalAmount = document.getElementById('finalAmount');

    if (data.success) {
      appliedCoupon = data.coupon;
      appliedCoupon.discountValue = data.discount;

      // Update feedback and UI
      feedback.textContent = `Coupon "${data.coupon.code}" applied. Discount: â‚¹${data.discount}`;
      feedback.classList.remove('text-danger');
      feedback.classList.add('text-success');

      discountRow.style.display = 'table-row';
      discountAmount.textContent = `- â‚¹${data.discount}`;

      // Apply discount freshly
      finalAmountValue = baseSubtotal - data.discount;
      finalAmount.textContent = `â‚¹${finalAmountValue}`;

      applyBtn.classList.add('d-none');
      removeBtn.classList.remove('d-none');
    } else {
      feedback.textContent = data.message;
      feedback.classList.remove('text-success');
      feedback.classList.add('text-danger');

      discountRow.style.display = 'none';
      discountAmount.textContent = '- â‚¹0';
      finalAmount.textContent = `â‚¹${baseSubtotal}`;
      finalAmountValue = baseSubtotal;
    }
  });
});

removeBtn.addEventListener('click', () => {
  const discountRow = document.getElementById('discountRow');
  const discountAmount = document.getElementById('discountAmount');
  const finalAmount = document.getElementById('finalAmount');

  appliedCoupon = null;
  codeInput.value = "";
  finalAmountValue = baseSubtotal;

  discountRow.style.display = 'none';
  discountAmount.textContent = '- â‚¹0';
  finalAmount.textContent = `â‚¹${baseSubtotal}`;

  applyBtn.classList.remove('d-none');
  removeBtn.classList.add('d-none');
  feedback.textContent = '';
});
</script>


<script>
  document.querySelectorAll('input[name="payment_option"]').forEach((radio) => {
  radio.addEventListener('change', () => {
    const selected = document.querySelector('input[name="payment_option"]:checked').value;
    const codNote = document.getElementById('codAdvanceNote');
    const advanceRow = document.getElementById('advanceRow');
    const advanceAmount = document.getElementById('advanceAmount');

    // Coupon elements
    const couponInput = document.getElementById('couponCode');
    const applyBtn = document.getElementById('applyCouponBtn');
    const removeBtn = document.getElementById('removeCouponBtn');
    const availableCoupons = document.getElementById('availableCoupons');
    const discountRow = document.getElementById('discountRow');
    const discountAmount = document.getElementById('discountAmount');
    const finalAmount = document.getElementById('finalAmount');

    if (selected === 'cashondelivery') {

      // Disable coupon system completely
      couponInput.disabled = true;
      applyBtn.disabled = true;

      // Hide available coupon list
      availableCoupons.classList.add('d-none');

      // Remove applied coupon if any
      appliedCoupon = null;
      couponInput.value = '';

      discountRow.style.display = "none";
      discountAmount.textContent = "- â‚¹0";

      finalAmountValue = baseSubtotal;
      finalAmount.textContent = `â‚¹${finalAmountValue}`;

      // COD Advance logic
      codNote.classList.remove('d-none');
      codAdvance = Math.round(finalAmountValue * 0.25);
      advanceRow.style.display = 'table-row';
      advanceAmount.textContent = `â‚¹${codAdvance}`;
    } 
    else {
      // Enable coupons back
      couponInput.disabled = false;
      applyBtn.disabled = false;
      availableCoupons.classList.remove('d-none');

      codNote.classList.add('d-none');
      advanceRow.style.display = 'none';
      codAdvance = 0;
    }
  });
});

</script>



<script>
const btn_checkout = document.getElementById('btn_checkout');

btn_checkout.addEventListener('click', () => {
  const selectedAddress = document.querySelector('input[name="checkAddress"]:checked');
  const selectedPaymentMethod = document.querySelector('input[name="payment_option"]:checked').value;

  if (!selectedAddress) {
    Swal.fire({ title: 'Error', text: 'Please select an address.', icon: 'error' });
    return;
  }

  const requestData = {
    address: selectedAddress.value,
    paymentMethod: selectedPaymentMethod,
    coupon: appliedCoupon?.code || null,
    couponDiscount: appliedCoupon?.discountValue || 0,
    finalAmount: finalAmountValue,
    codAdvance: codAdvance
  };

  // ðŸŸ  COD - 25% Advance
  if (selectedPaymentMethod === 'cashondelivery') {
    Swal.fire({
      title: "Pay 25% COD Advance",
      text: `You need to pay â‚¹${codAdvance} now to confirm your COD order.`,
      showCancelButton: true,
      confirmButtonText: "Pay with Razorpay",
      cancelButtonText: "Use Wallet",
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#2ecc71"
    }).then((result) => {
      if (result.isConfirmed) {
        // Razorpay COD Advance
        fetch('/checkout/create-razorpay-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...requestData, finalAmount: codAdvance })
        })
        .then(res => res.json())
        .then(order => {
          const rzp = new Razorpay({
            key: '<%= razorpayKey %>',
            amount: order.amount,
            currency: "INR",
            name: "Catering COD Advance",
            description: "COD Advance Payment",
            order_id: order.id,
            modal: {
              ondismiss: function () {
                Swal.fire("Payment Cancelled", "You closed the payment popup.", "info")
                .then(() => window.location.href = "/orderFailed");
              }
            },
            handler: function (response) {
              fetch('/checkout/verify-razorpay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...response, ...requestData })
              })
              .then(res => res.json())
              .then(result => {
                if (result.success) {
                  Swal.fire({ icon: "success", title: result.message })
                    .then(() => window.location.href = '/orderSuccess');
                } else {
                  Swal.fire("Error", result.error, "error")
                    .then(() => window.location.href = result.orderId ? `/order/${result.orderId}/failure` : '/orderFailed');
                }
              });
            }
          });
          rzp.open();
        });

      } else {
        // Wallet COD Advance
        fetch('/checkout/pay-cod-wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire("Success", data.message, "success")
              .then(() => window.location.href = "/orderSuccess");
          } else {
            Swal.fire("Error", data.error, "error")
              .then(() => window.location.href = data.orderId ? `/order/${data.orderId}/failure` : '/orderFailed');
          }
        });
      }
    });
  }

  // ðŸ’³ Online full payment
  else if (selectedPaymentMethod === 'online') {
    fetch('/checkout/create-razorpay-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    })
    .then(res => res.json())
    .then(order => {
      const rzp = new Razorpay({
        key: '<%= razorpayKey %>',
        amount: order.amount,
        currency: "INR",
        name: "Catering Service",
        description: "Order Payment",
        order_id: order.id,
        modal: {
          ondismiss: function () {
            Swal.fire("Payment Cancelled", "You closed the payment popup.", "info")
              .then(() => window.location.href = "/orderFailed");
          }
        },
        handler: function (response) {
          fetch('/checkout/verify-razorpay', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...response, ...requestData })
          })
          .then(res => res.json())
          .then(result => {
            if (result.success) {
              Swal.fire({ title: "Success", text: result.message, icon: "success" })
                .then(() => window.location.href = '/orderSuccess');
            } else {
              Swal.fire("Error", result.error, "error")
                .then(() => window.location.href = result.orderId ? `/order/${result.orderId}/failure` : '/orderFailed');
            }
          });
        },
        prefill: {
          name: "<%= userData.firstname %>",
          email: "<%= userData.email %>",
          contact: "<%= userData.phoneno %>"
        },
        theme: { color: "#3399cc" }
      });
      rzp.open();
    });
  }

  // ðŸ’¼ Wallet full payment
  else {
    fetch('/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestData)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        Swal.fire({ title: "Success", text: data.message, icon: "success" })
          .then(() => window.location.href = '/orderSuccess');
      } else {
        Swal.fire("Error!", data.error, "error");
      }
    });
  }
});
</script>



<script>
  // âœ… Load Available Coupons
document.addEventListener('DOMContentLoaded', () => {
  fetch('/availableCoupons', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cartTotal: finalAmountValue })
  })
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById('availableCoupons');
    container.innerHTML = '';

    if (!data.success || data.coupons.length === 0) {
      container.innerHTML = '<p class="text-muted">No available coupons at the moment.</p>';
      return;
    }

    data.coupons.forEach(coupon => {
      const div = document.createElement('div');
      div.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'border-bottom', 'py-2');
      div.innerHTML = `
        <div>
          <strong>${coupon.code}</strong>
          <p class="mb-0 small text-muted">
            ${coupon.description || ''}
            <br>
            ${coupon.discountType === 'percentage'
              ? `Discount: ${coupon.discountValue}%`
              : `Discount: â‚¹${coupon.discountValue}`}
          </p>
        </div>
        <button class="btn btn-sm btn-outline-success apply-this-coupon" data-code="${coupon.code}">
          Apply
        </button>
      `;
      container.appendChild(div);
    });

    // Single coupon click â€” automatically applies that coupon
    document.querySelectorAll('.apply-this-coupon').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const code = e.target.getAttribute('data-code');
        document.getElementById('couponCode').value = code;
        document.getElementById('applyCouponBtn').click();
      });
    });
  })
  .catch(err => {
    console.error('Coupon load error:', err);
    document.getElementById('availableCoupons').innerHTML = '<p class="text-danger">Failed to load coupons.</p>';
  });
});

</script>


