<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  rel="stylesheet"
/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; }
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background-attachment: fixed;
    font-family: 'Poppins', sans-serif;
  }
  .content-main { background: transparent; }
  .container-fluid {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 25px;
    padding: 30px;
    backdrop-filter: blur(10px);
    margin-top: 20px;
  }
  h3.fw-bold.text-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  h3.fw-bold.text-primary i {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2rem;
  }
  .text-muted { color: rgba(255, 255, 255, 0.8) !important; font-weight: 500; }
  .card {
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  .form-control, .form-select, .input-group-text {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    padding: 10px 20px;
    font-weight: 500;
    color: #4a5568;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
  }
  .form-control:hover, .form-select:hover {
    border-color: rgba(102, 126, 234, 0.5);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    transform: translateY(-2px);
  }
  .form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    outline: none;
  }
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 12px;
    padding: 12px 28px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }
  .table {
    font-family: 'Poppins', sans-serif;
  }
  .table thead th {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    color: #2d3748;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    border: none;
    padding: 15px;
  }
  .table tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  .table tbody tr:hover {
    background: rgba(102, 126, 234, 0.05);
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  .badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: 0.3px;
  }
  .btn-sm {
    padding: 8px 18px;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s ease;
    border-width: 2px;
  }
  .btn-outline-primary:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .btn-outline-danger:hover {
    background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
    border-color: transparent;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
  }
</style>

<section class="content-main mt-4">
  <div class="container-fluid">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="fw-bold text-primary mb-0">
          <i class="bi bi-ticket-perforated-fill me-2"></i>Coupon Management
        </h3>
        <small class="text-muted">View, search, and manage discount coupons</small>
      </div>
      <a href="/admin/addCoupon" class="btn btn-primary rounded-pill px-3">
        <i class="bi bi-plus-circle me-1"></i> Add Coupon
      </a>
    </div>

    <!-- FILTER + SEARCH BAR -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="flex-grow-1">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search text-muted"></i>
            </span>
            <input
              type="text"
              id="searchInput"
              class="form-control border-start-0"
              placeholder="Search coupon by code..."
            />
          </div>
        </div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card shadow border-0">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="couponTable">
            <thead class="table-light">
              <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Min Order</th>
                <th>Expiry</th>
                <th>Used By</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% coupons.forEach(coupon => { %>
                <tr>
                  <td class="fw-semibold text-primary"><%= coupon.code %></td>
                  <td><%= coupon.discountType %></td>
                  <td>₹<%= coupon.discountValue %></td>
                  <td>₹<%= coupon.minOrderAmount %></td>
                  <td><%= new Date(coupon.expiryDate).toLocaleDateString() %></td>
                  <td><span class="used-count"><%= coupon.usedBy.length %></span></td>

                  <td class="text-center">
                    <button
                      class="btn btn-outline-danger btn-sm rounded-pill"
                      onclick="confirmDelete('<%= coupon._id %>')"
                    >
                      <i class="bi bi-trash3"></i>
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- PAGINATION -->
        <div class="d-flex justify-content-end mt-3 gap-2 flex-wrap" id="pagination">
          <% for (let i = 1; i <= totalPages; i++) { %>
            <button
              class="btn btn-sm px-3 rounded-pill page-btn <%= i === currentPage ? 'btn-primary text-white' : 'btn-outline-primary' %>"
              data-page="<%= i %>"
            >
              <%= i %>
            </button>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  <style>
    .used-count {
      background-color: #e7f1ff; /* soft light blue */
      color: #0d6efd; /* bootstrap primary */
      font-weight: 600;
      border-radius: 50px;
      padding: 4px 10px;
      font-size: 0.9rem;
    }
  </style>
  
</section>

<!-- SWEETALERT -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- AJAX + SEARCH + PAGINATION -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const table = document.getElementById("couponTable");
    const paginationContainer = document.getElementById("pagination");
    let currentPage = 1;
    let debounceTimer;

    async function fetchCoupons(page = 1, search = "") {
      const res = await fetch(`/admin/coupons?page=${page}&search=${search}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      const data = await res.json();

      const tbody = table.querySelector("tbody");
      tbody.innerHTML = "";

      if (data.coupons.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">No coupons found</td></tr>`;
      } else {
        data.coupons.forEach((coupon) => {
          tbody.innerHTML += `
            <tr>
              <td class="fw-semibold text-primary">${coupon.code}</td>
              <td>${coupon.discountType}</td>
              <td>₹${coupon.discountValue}</td>
              <td>₹${coupon.minOrderAmount}</td>
              <td>${new Date(coupon.expiryDate).toLocaleDateString()}</td>
              <td><span class="badge bg-info-subtle text-info">${coupon.usedBy.length}</span></td>
              <td class="text-center">
                <button class="btn btn-outline-danger btn-sm rounded-pill" onclick="confirmDelete('${coupon._id}')">
                  <i class="bi bi-trash3"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }

      // Update pagination
      paginationContainer.innerHTML = "";
      for (let i = 1; i <= data.totalPages; i++) {
        paginationContainer.innerHTML += `
          <button
            class="btn btn-sm px-3 rounded-pill page-btn ${
              i === data.currentPage ? "btn-primary text-white" : "btn-outline-primary"
            }"
            data-page="${i}"
          >
            ${i}
          </button>
        `;
      }

      attachPaginationEvents(search);
    }

    function attachPaginationEvents(search = "") {
      document.querySelectorAll(".page-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          currentPage = parseInt(btn.dataset.page);
          fetchCoupons(currentPage, search);
        });
      });
    }

    // Debounced live search
    searchInput.addEventListener("keyup", () => {
      const searchValue = searchInput.value.trim();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        currentPage = 1;
        fetchCoupons(currentPage, searchValue);
      }, 400);
    });

    attachPaginationEvents();
  });

  // SWEETALERT DELETE
  function confirmDelete(couponId) {
    Swal.fire({
      title: "Delete Coupon?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it!",
      cancelButtonText: "Cancel",
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/admin/coupon/delete/${couponId}`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>
