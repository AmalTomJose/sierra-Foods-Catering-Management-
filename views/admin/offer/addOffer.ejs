<h3 class="mb-4 text-primary fw-bold">Add Offer</h3>

<form method="POST" action="/admin/saveOffer" onsubmit="return validateForm()" class="border p-4 rounded bg-light shadow-sm">

  <div class="row g-3">
    <!-- Title -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="text" id="title" name="title" class="form-control" placeholder="Title" required />
        <label for="title">Offer Title</label>
      </div>
    </div>

    <!-- Discount Type -->
    <div class="col-md-6">
      <div class="form-floating">
        <select name="discountType" id="discountType" class="form-select" required>
          <option value="" selected disabled>Select Type</option>
          <option value="percentage">Percentage (%)</option>
          <option value="amount">Flat Amount</option>
        </select>
        <label for="discountType">Discount Type</label>
      </div>
    </div>

    <!-- Discount Value -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="number" id="discountValue" name="discountValue" class="form-control" placeholder="Value" min="1" required />
        <label for="discountValue">Discount Value</label>
      </div>
    </div>

    <!-- Apply To -->
    <div class="col-md-6">
      <div class="form-floating">
        <select name="applicableTo" class="form-select" id="applyToSelect" required>
          <option value="all">All Products</option>
          <option value="category">Specific Category</option>
          <option value="product">Specific Products</option>
        </select>
        <label for="applyToSelect">Apply Offer To</label>
      </div>
    </div>

    <!-- Category Select -->
    <div class="col-md-6" id="categorySelect" style="display: none;">
      <label for="category" class="form-label">Choose Category</label>
      <select name="category" id="category" class="form-select">
        <% categories.forEach(cat => { %>
          <option value="<%= cat._id %>"><%= cat.cat_name %></option>
        <% }) %>
      </select>
    </div>
    <!-- Product Select -->
<div class="col-md-6" id="productSelect" style="display: none;">
  <label for="products" class="form-label">Select Products</label>
  <select name="products" id="products" class="form-select" multiple size="8" style="height: 200px; overflow-y: auto;">
    <% products.forEach(prod => { %>
      <option value="<%= prod._id %>"><%= prod.item_name %></option>
    <% }) %>
  </select>
  <small class="text-muted">Hold Ctrl (or Cmd on Mac) to select multiple products.</small>
</div>

    <!-- Description -->
    <div class="col-12">
      <label for="description" class="form-label">Offer Description</label>
      <textarea id="description" name="description" rows="3" class="form-control" required placeholder="Short description..."></textarea>
    </div>

    <!-- Start & End Date -->
    <div class="col-md-6">
      <label for="startDate" class="form-label">Start Date</label>
      <input type="date" id="startDate" name="startDate" class="form-control" required />
    </div>

    <div class="col-md-6">
      <label for="endDate" class="form-label">End Date</label>
      <input type="date" id="endDate" name="endDate" class="form-control" required />
    </div>

    <!-- Submit Button -->
    <div class="col-12 text-end mt-3">
      <button type="submit" class="btn btn-success px-4">
        <i class="fas fa-plus-circle me-2"></i> Add Offer
      </button>
    </div>
  </div>
</form>



<script>
  document.addEventListener('DOMContentLoaded', function () {
    const applyTo = document.getElementById('applyToSelect');
    const categoryDiv = document.getElementById('categorySelect');
    const productDiv = document.getElementById('productSelect');
    const categorySelect = document.getElementById('category');
    const productSelect = document.getElementById('products');
    function toggleTargetFields() {
  const selected = applyTo.value;

  if (selected === 'category') {
    categoryDiv.style.display = 'block';
    productDiv.style.display = 'none';

    categorySelect.removeAttribute('disabled');
    categorySelect.setAttribute('required', 'required');

    productSelect.setAttribute('disabled', 'disabled');
    productSelect.removeAttribute('required');

  } else if (selected === 'product') {
    productDiv.style.display = 'block';
    categoryDiv.style.display = 'none';

    productSelect.removeAttribute('disabled');
    productSelect.setAttribute('required', 'required');

    categorySelect.setAttribute('disabled', 'disabled');
    categorySelect.removeAttribute('required');

  } else {
    categoryDiv.style.display = 'none';
    productDiv.style.display = 'none';

    categorySelect.setAttribute('disabled', 'disabled');
    productSelect.setAttribute('disabled', 'disabled');

    categorySelect.removeAttribute('required');
    productSelect.removeAttribute('required');
  }
}


    applyTo.addEventListener('change', toggleTargetFields);
    toggleTargetFields(); // initial check
  });

  function validateForm() {
    const discountValue = parseFloat(document.getElementById('discountValue').value);
    const discountType = document.getElementById('discountType').value;
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (discountType === 'percentage' && (discountValue < 1 || discountValue > 100)) {
      alert('Percentage must be between 1 and 100');
      return false;
    }

    if (discountValue < 1) {
      alert('Discount value must be greater than 0');
      return false;
    }

    if (startDate < today) {
      alert('Start date must be today or in the future');
      return false;
    }

    if (endDate <= startDate) {
      alert('End date must be after start date');
      return false;
    }

    return true;
  }
</script>
