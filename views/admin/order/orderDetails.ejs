<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<section class="content-main">
  <div class="content-header">
    <div>
      <h2 class="content-title card-title">Order detail</h2>
      <p>Details for Order ID: <%= order._id %></p>
    </div>
  </div>
  <div class="card">
    <header class="card-header">
      <div class="row align-items-center">
        <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
          <i class="material-icons md-calendar_today"></i>
          <small class="text-muted">Ordered Date:</small> <b><%= new Date(order.orderDate).toLocaleDateString() %></b><br>
          <small class="text-muted">Order ID: <%= order._id %></small><br>
          <small class="text-muted">Order Status:</small>
          <% if (order.status) { %>
            <span class="badge badge-pill badge-soft-warning"><%= order.status %></span>
            <form action="/admin/updateorderStatus" method="POST" class="mt-2">
              <input type="hidden" name="orderId" value="<%= order._id %>">
              <div class="d-flex align-items-center gap-2">
                <select name="status" class="form-select form-select-sm w-auto">
                  <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                  <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                  <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                  <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                  <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
                </select>
                <button type="submit" class="btn btn-sm btn-success">Update</button>
              </div>
            </form>
            
          <% } %><br>
          <small class="text-muted">Delivery Date:</small> <b><%= new Date(order.booking.eventDate).toLocaleDateString() %></b>
        </div>
        <div class="col-lg-6 col-md-6 ms-auto text-md-end">
          <% if (order.refundStatus !== undefined) { %>
            <label for="refundStatusDropdown" class="form-label mt-3">Refund Status</label>
            <select id="refundStatusDropdown" class="form-select d-inline-block mb-lg-0 mb-15 mw-200">
              <option value="none" <%= order.refundStatus === 'none' ? 'selected' : '' %>>None</option>
              <option value="requested" <%= order.refundStatus === 'requested' ? 'selected' : '' %>>Requested</option>
              <option value="approved" <%= order.refundStatus === 'approved' ? 'selected' : '' %>>Approved</option>
            </select>
            <button class="btn btn-success" onclick="saveRefundStatus('<%= order._id %>')">Update Refund</button>
          <% } %>
        </div>
      </div>
    </header>
    <div class="card-body">
      <div class="row mb-50 mt-20 order-info-wrap">
        <div class="col-md-4">
          <article class="icontext align-items-start">
            <span class="icon icon-sm rounded-circle bg-primary-light">
              <i class="text-primary material-icons md-person"></i>
            </span>
            <div class="text">
              <h6 class="mb-1">Customer</h6>
              <p class="mb-1">
                <%=order.user.firstname%><br>
                <%=order.user.phoneno%>
              </p>
              <a href="#">View profile</a>
            </div>
          </article>
        </div>
        <div class="col-md-4">
          <article class="icontext align-items-start">
            <span class="icon icon-sm rounded-circle bg-primary-light">
              <i class="text-primary material-icons md-local_shipping"></i>
            </span>
            <div class="text">
              <h6 class="mb-1">Order Info</h6>
              <p class="mb-1">
                Shipping: Fargo Express<br>
                Pay method: <%=order.paymentMethod %><br>
                Status: <%=order.status %>
              </p>
              <a href="#">Download info</a>
            </div>
          </article>
        </div>
        <div class="col-md-4">
          <article class="icontext align-items-start">
            <span class="icon icon-sm rounded-circle bg-primary-light">
              <i class="text-primary material-icons md-place"></i>
            </span>
            <div class="text">
              <h6 class="mb-1">Deliver to</h6>
              <p class="mb-1">
                Event Date: <%= order.booking.eventDate %><br>
                Event Type: <%= order.booking.eventType %><br>
                Guest Count: <%= order.booking.guestCount %><br>
                Event Place: <%= order.booking.eventPlace %><br>
                Event Time: <%= order.booking.eventTime %><br>
                District: <%= order.booking.eventDistrict %><br>
                Pincode: <%= order.booking.eventPincode %>
              </p>
            </div>
          </article>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Item Status</th>
              <th>Refund Status</th>
              <th>Price Before Discount</th>
              <th>Discount Applied</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>
          <tbody>
            <% let subtotalBeforeDiscount = 0, totalCouponDiscount = 0, finalPayable = 0; %>
            <% order.items.forEach(item => {
              const quantity = item.quantity;
              const unitPrice = item.price;
              const totalBeforeDiscount = unitPrice * quantity;
              const discount = item.couponDiscount || 0;
              const finalTotal = totalBeforeDiscount - discount;
              subtotalBeforeDiscount += totalBeforeDiscount;
              totalCouponDiscount += discount;
              finalPayable += finalTotal;
            %>
            <tr>
              <td>
                <div class="d-flex">
                  <img src="/admin-assets/imgs/productIMG/<%= item.product.item_image[0] %>" class="img-sm me-2">
                  <div><%= item.product.item_name %></div>
                </div>
              </td>
              <td><%= quantity %></td>
              <td>₹<%= unitPrice %></td>
              <td><%= item.status %></td>
              <td>
                <select class="form-select item-status-dropdown" data-order-id="<%= order._id %>" data-item-id="<%= item._id %>">
                  <option value="none" <%= item.refundStatus === 'none' ? 'selected' : '' %>>None</option>
                  <option value="requested" <%= item.refundStatus === 'requested' ? 'selected' : '' %>>Requested</option>
                  <option value="approved" <%= item.refundStatus === 'approved' ? 'selected' : '' %>>Approved</option>
                </select>
                <button class="btn btn-outline-success btn-sm mt-1" onclick="updateItemRefundStatus('<%= order._id %>', '<%= item._id %>')">Save</button>
              </td>
              <td>₹<%= totalBeforeDiscount %></td>
              <td>₹<%= discount %></td>
              <td class="text-end">₹<%= finalTotal %></td>
            </tr>
            <% }) %>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="8">
                <article class="float-end text-end">
                  <dl class="dlist">
                    <dt>Subtotal (before discount):</dt>
                    <dd>₹<%= subtotalBeforeDiscount %></dd>
                  </dl>
                  <dl class="dlist">
                    <dt>Coupon Discount:</dt>
                    <dd>- ₹<%= totalCouponDiscount %></dd>
                  </dl>
                  <% if (order.advancePaid && order.paymentMethod === 'COD') { %>
                    <dl class="dlist">
                      <dt>Advance Paid:</dt>
                      <dd>- ₹<%= order.advancePaid %> (via <%= order.advanceMethod || 'Razorpay' %>)</dd>
                    </dl>
                  <% } %>
                  <dl class="dlist">
                    <dt>Final Payable:</dt>
                    <dd><b class="h5">₹<%= finalPayable %></b></dd>
                  </dl>
                </article>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
  function saveRefundStatus(orderId) {
    const selectedStatus = document.getElementById("refundStatusDropdown").value;
    fetch('/admin/orderstatus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId, status: selectedStatus })
    })
    .then(res => res.json())
    .then(data => {
      Swal.fire({ icon: 'success', title: 'Updated', text: `Status: ${data.updatedStatus}` }).then(() => location.reload());
    })
    .catch(err => {
      Swal.fire({ icon: 'error', title: 'Update Failed', text: 'Please try again.' });
    });
  }

  function updateItemRefundStatus(orderId, itemId) {
    const select = document.querySelector(`select[data-order-id="${orderId}"][data-item-id="${itemId}"]`);
    const status = select.value;
    fetch('/admin/update-item-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ orderId, itemId, status })
    })
    .then(res => res.json())
    .then(data => {
      Swal.fire({ icon: 'success', title: 'Item Updated', text: `Refund Status: ${data.updatedStatus}` });
    })
    .catch(err => {
      Swal.fire({ icon: 'error', title: 'Update Failed', text: 'Something went wrong.' });
    });
  }
</script>
