<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

<section class="content-main">


  <div class="card mb-4">
    <header class="card-header">
      <form action="" method="get">
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="text" id="searchInput" class="form-control" placeholder="Search for Name...">

          <div class="col-md-3 col-12 me-auto mb-md-0 mb-3" style="display: flex;">
            <label for="status" class="form-control">Select Status:</label>
            <select name="status" class="form-select" id="statusFilter">
              <option value="">All</option>
              <option value="confirmed">Confirmed</option>
              <option value="requested">Requested</option>
              <option value="cancelled">Cancelled</option>
              <option value="pending">Pending</option>
            </select>
            
            
          </div>

          <input type="submit" class="btn btn-sm font-sm rounded btn-brand" value="Filter">
        </div>
      </form>
    </header>

    <div class="card-body">
      <table id="products" class="table">
        <thead>
          <tr>
            <th>Order</th>
            <th>Name</th>
            <th>Order Date</th>
            <th>Delivery Date</th>
            <th>Status</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <% order.forEach(function(order_data) { %>
            <tr>
              <td><%= order_data.orderId %></td>
              <td><%= order_data.user?.firstname || 'Unknown' %></td>
              <td><%= new Date(order_data.orderDate).toLocaleDateString() %></td>
              <td><%= new Date(order_data.deliveryDate).toLocaleDateString() %></td>
              <td class="<%= order_data.status.trim().toLowerCase() === 'confirmed' ? 'text-success' : order_data.status.trim().toLowerCase() === 'requested' ? 'text-danger' : 'text-warning' %>">
                <%= order_data.status %>
              </td>
              

              
              <td><%= order_data.totalAmount %></td>
              <td>
                <a href="/admin/orderDetails?orderId=<%= order_data._id %>" class="btn btn-sm btn-primary">View</a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Pagination Section -->
      <% if (totalPages > 1) { %>
        <nav class="mt-4" aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <% if (currentPage > 1) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
            <% } %>

            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>"><%= i %></a>
              </li>
            <% } %>

            <% if (currentPage < totalPages) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            <% } %>
          </ul>
        </nav>
      <% } %>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const table = document.getElementById("products");
    const rows = table.getElementsByTagName("tr");
    console.log(rows)

    searchInput.addEventListener("keyup", function () {
      const searchText = searchInput.value.toLowerCase();
      for (let i = 1; i <  rows.length; i++) {
        const rowData = rows[i].textContent.toLowerCase();
        rows[i].style.display = rowData.includes(searchText) ? "" : "none";
      }
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const statusDropdown = document.getElementById("statusFilter");
    const tbody = document.querySelector("table tbody");

    statusDropdown.addEventListener("change", function () {
      const selectedStatus = this.value;

      fetch(`/admin/orders?status=${selectedStatus}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
        .then(res => res.json())
        .then(data => {
          tbody.innerHTML = ""; // Clear current rows

          data.orders.forEach(order => {
            const tr = document.createElement("tr");

            const statusClass =
              order.status.toLowerCase() === "confirmed"
                ? "text-success"
                : order.status.toLowerCase() === "requested"
                ? "text-danger"
                : "text-warning";

            tr.innerHTML = `
              <td>${order.orderId}</td>
              <td>${order.user?.firstname || "Unknown"}</td>
              <td>${new Date(order.orderDate).toLocaleDateString()}</td>
              <td>${new Date(order.deliveryDate).toLocaleDateString()}</td>
              <td class="${statusClass}">${order.status}</td>
              <td>${order.totalAmount}</td>
              <td><a href="/admin/orderDetails?orderId=${order._id}" class="btn btn-sm btn-primary">View</a></td>
            `;

            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error("Error loading filtered orders:", err);
        });
    });
  });
</script>

